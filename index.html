<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Love Tester ‚Ä¢ App</title>
    <meta name="description" content="Love Tester ‚Äî app em HTML: calcule a compatibilidade entre dois nomes, salve e compartilhe." />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23ff4d8d'/%3E%3Ctext x='50' y='58' font-size='48' text-anchor='middle' font-family='Poppins,Arial' fill='white'%3E%E2%9D%A4%EF%B8%8F%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Vari√°veis de cores para temas */
        :root {
            --bg1: #1a082b;
            --bg2: #3a005c;
            --accent: #ff4d8d;
            --accent2: #8b5cf6;
            --muted: #cdbfe8;
            --text: #f8f5ff;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg1), var(--bg2));
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            transition: background-color 0.8s ease-in-out, background-image 0.8s ease-in-out;
        }

        .device {
            width: min(420px, 94vw);
            height: min(820px, 92vh);
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .appbar {
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(255, 77, 141, 0.1);
            transition: all 0.3s ease;
        }

        .content-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            inset: 0;
            padding: 1.5rem;
            transition: opacity 0.3s ease, transform 0.3s ease;
            overflow-y: auto;
        }

        .screen.hidden {
            opacity: 0;
            transform: translateX(100%);
            pointer-events: none;
        }

        .screen.active {
            opacity: 1;
            transform: translateX(0);
        }

        .field label {
            font-size: 0.875rem;
            color: var(--muted);
            margin-bottom: 0.5rem;
            display: block;
        }

        .field input, .field select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text);
            outline: none;
            transition: all 0.2s;
        }

        .field input:focus, .field select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 77, 141, 0.2);
        }

        .btn-base {
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white;
            box-shadow: 0 10px 20px rgba(255, 77, 141, 0.15);
        }

        .btn-primary:hover {
            box-shadow: 0 12px 25px rgba(255, 77, 141, 0.25);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent2), var(--accent));
            color: white;
            box-shadow: 0 10px 20px rgba(91, 33, 182, 0.15);
        }

        .btn-secondary:hover {
            box-shadow: 0 12px 25px rgba(91, 33, 182, 0.25);
            transform: translateY(-2px);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text);
            box-shadow: none;
        }

        .btn-ghost:hover {
            background: var(--card-bg);
            transform: translateY(-2px);
        }

        .btn-animated {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 77, 141, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(255, 77, 141, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 77, 141, 0); }
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            padding: 1.25rem;
        }

        .result-percent {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            background: -webkit-linear-gradient(45deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: all 0.5s ease-out;
        }

        .bottom-nav {
            background: rgba(255, 255, 255, 0.02);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .nav-item {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.75rem;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .chip {
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .chip.active {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white;
            border: none;
            box-shadow: 0 8px 16px rgba(255, 77, 141, 0.15);
            transform: scale(1.05);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            display: grid;
            place-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1000;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal.open .modal-content {
            transform: scale(1);
        }

        .error-message {
            color: var(--accent);
            font-weight: 600;
        }

        .heart-particle-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .heart-particle {
            position: absolute;
            top: 100%;
            font-size: 1rem;
            animation: rise-and-fade 4s ease-in forwards;
            opacity: 0;
            will-change: transform, opacity;
        }

        @keyframes rise-and-fade {
            0% { transform: translateY(0) scale(0); opacity: 0; }
            10% { opacity: 1; transform: translateY(-5%) scale(1); }
            100% { transform: translateY(-100vh) scale(1.5); opacity: 0; }
        }

        .photo-preview {
            width: 100%;
            height: 120px;
            border-radius: 0.75rem;
            object-fit: cover;
            object-position: center;
            border: 1px solid var(--border-color);
            margin-top: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: none;
        }

        .photo-preview.active {
            display: block;
        }

        .photo-upload-label {
            display: block;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-upload-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .photo-upload-label i {
            margin-right: 0.5rem;
        }

        #modalPersonality .modal-content {
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-content-container {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
        }

        .btn-friend-detailed {
            background: linear-gradient(135deg, #ff8c00, #5cb6f6);
            color: white;
            box-shadow: 0 10px 20px rgba(255, 140, 0, 0.15);
        }

        .btn-friend-detailed:hover {
            box-shadow: 0 12px 25px rgba(255, 140, 0, 0.25);
        }

        .btn-friend {
            background: linear-gradient(135deg, #1e90ff, #ff8c00);
            color: white;
            box-shadow: 0 10px 20px rgba(30, 144, 255, 0.15);
        }

        .btn-friend:hover {
            box-shadow: 0 12px 25px rgba(30, 144, 255, 0.25);
        }
    </style>
    <!-- Inclui o Font Awesome para os √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Conte√∫do do manifest.json em um script, para ser lido pelo JS -->
    <script id="manifest-json" type="application/json">
        {
            "name": "Love Tester",
            "short_name": "Love Tester",
            "description": "Um aplicativo de teste de amor.",
            "start_url": "https://utters-apps.github.io/Love-Tester-",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#4f46e5",
            "icons": [
                {
                    "src": "https://pbs.twimg.com/media/GzYfRZZWwAArxXB?format=jpg&name=medium",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://pbs.twimg.com/media/GzYfRZZWwAArxXB?format=jpg&name=medium",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        }
    </script>
</head>
<body class="bg-gray-900">
<div class="device shadow-2xl">
    <header class="appbar">
        <div class="flex items-center gap-3">
            <div class="logo-icon text-2xl">üíñ</div>
            <div>
                <h2 id="appTitle" class="text-white text-lg font-bold">Love Tester</h2>
                <p class="text-sm text-gray-400">Descubra a sua qu√≠mica</p>
            </div>
        </div>
        <button id="btnHelp" class="ml-auto btn-base btn-ghost text-lg">
            <i class="fas fa-question-circle"></i>
        </button>
    </header>

    <div id="heartParticles" class="heart-particle-container"></div>

    <main class="content-container">
        <!-- Tela Inicial -->
        <section id="screenHome" class="screen active">
            <div class="flex flex-col items-center justify-center text-center p-4 gap-6">
                <div class="logo-icon text-5xl p-6 rounded-3xl shadow-xl">üíû</div>
                <h1 class="text-3xl font-bold">Descubra a sua qu√≠mica</h1>
                <p class="text-sm text-gray-400">Escolha um teste para calcular a compatibilidade, salve e compartilhe o resultado.</p>
                <div class="flex flex-col gap-4 w-full">
                    <button class="btn-base btn-primary w-full" id="openSimple">
                        <i class="fas fa-heart"></i> Conex√£o de Almas
                    </button>
                    <button class="btn-base btn-secondary w-full" id="openAdvanced">
                        <i class="fas fa-gem"></i> Qu√≠mica Perfeita
                    </button>
                    <button class="btn-base w-full btn-friend-detailed" id="openDetailedFriend">
                        <i class="fas fa-handshake"></i> Sintonia de Almas
                    </button>
                    <button class="btn-base w-full btn-friend" id="openFriend">
                        <i class="fas fa-user-friends"></i> Vibe de Amizade
                    </button>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button class="btn-base btn-ghost" id="openHistory">
                    <i class="fas fa-history"></i> Hist√≥rico
                </button>
            </div>
        </section>

        <!-- Tela Simples -->
        <section id="screenSimple" class="screen hidden">
            <div class="space-y-4">
                <div class="field">
                    <label for="s_nome1">Seu Nome</label>
                    <input id="s_nome1" type="text" placeholder="Ex.: Ana" class="rounded-xl">
                </div>
                <div class="field">
                    <label for="s_nome2">Nome da Outra Pessoa</label>
                    <input id="s_nome2" type="text" placeholder="Ex.: Bruno" class="rounded-xl">
                </div>
                <div class="flex gap-2">
                    <button class="btn-base btn-primary flex-1 btn-animated" id="calcSimple">
                        <i class="fas fa-calculator"></i> Calcular
                    </button>
                    <button class="btn-base btn-ghost" id="swapSimple">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button class="btn-base btn-ghost" id="clearSimple">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
            <div class="card mt-6 text-center space-y-4">
                <div id="badgeSimple" class="text-sm text-gray-400 font-semibold">‚Äî</div>
                <div id="percentSimple" class="result-percent text-8xl">0</div>
                <div id="msgSimple" class="text-sm text-gray-400">Preencha os nomes e toque em Calcular.</div>
                <div class="flex gap-2 mt-4">
                    <button class="btn-base btn-primary flex-1" id="saveSimple">
                        <i class="fas fa-download"></i> Salvar
                    </button>
                    <button class="btn-base btn-ghost flex-1" id="shareSimple">
                        <i class="fas fa-share-alt"></i> Compartilhar
                    </button>
                </div>
            </div>
        </section>

        <!-- Tela Avan√ßada -->
        <section id="screenAdvanced" class="screen hidden">
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-1">
                    <div class="field">
                        <label for="a_nome1">Seu Nome</label>
                        <input id="a_nome1" type="text" placeholder="Ex.: Carolina">
                    </div>
                    <div class="field mt-4">
                        <label>Sua Personalidade</label>
                        <button class="btn-base btn-ghost w-full" id="openPersModal1">
                            <i class="fas fa-sliders-h"></i> Escolher Personalidade
                        </button>
                        <div id="selectedPers1" class="flex flex-wrap gap-1 mt-2 text-xs text-gray-400"></div>
                    </div>
                    <div class="field mt-4">
                        <label for="a_foto1">Sua Foto</label>
                        <label for="a_foto1" class="photo-upload-label">
                            <i class="fas fa-camera"></i> Selecionar Foto
                        </label>
                        <input id="a_foto1" type="file" accept="image/*" class="hidden">
                        <img id="a_foto1_preview" class="photo-preview rounded-xl" alt="Preview da Foto 1">
                    </div>
                </div>
                <div class="flex-1">
                    <div class="field">
                        <label for="a_nome2">Nome da Outra Pessoa</label>
                        <input id="a_nome2" type="text" placeholder="Ex.: Lucas">
                    </div>
                    <div class="field mt-4">
                        <label>Personalidade da Outra Pessoa</label>
                        <button class="btn-base btn-ghost w-full" id="openPersModal2">
                            <i class="fas fa-sliders-h"></i> Escolher Personalidade
                        </button>
                        <div id="selectedPers2" class="flex flex-wrap gap-1 mt-2 text-xs text-gray-400"></div>
                    </div>
                    <div class="field mt-4">
                        <label for="a_foto2">Foto da Outra Pessoa</label>
                        <label for="a_foto2" class="photo-upload-label">
                            <i class="fas fa-camera"></i> Selecionar Foto
                        </label>
                        <input id="a_foto2" type="file" accept="image/*" class="hidden">
                        <img id="a_foto2_preview" class="photo-preview rounded-xl" alt="Preview da Foto 2">
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn-base btn-primary flex-1 btn-animated" id="calcAdvanced">
                    <i class="fas fa-calculator"></i> Calcular
                </button>
                <button class="btn-base btn-ghost" id="clearAdvanced">
                    <i class="fas fa-eraser"></i> Limpar
                </button>
            </div>
            <div class="card mt-6 text-center space-y-4">
                <div id="badgeAdvanced" class="text-sm text-gray-400 font-semibold">‚Äî</div>
                <div id="percentAdvanced" class="result-percent text-8xl">0</div>
                <div id="msgAdvanced" class="text-sm text-gray-400">Selecione personalidades para um resultado mais detalhado.</div>
                <div class="flex gap-2 mt-4">
                    <button class="btn-base btn-primary flex-1" id="saveAdvanced">
                        <i class="fas fa-download"></i> Salvar
                    </button>
                    <button class="btn-base btn-ghost flex-1" id="shareAdvanced">
                        <i class="fas fa-share-alt"></i> Compartilhar
                    </button>
                </div>
            </div>
        </section>

        <!-- NOVO: Tela Modo Amizade Detalhado -->
        <section id="screenDetailedFriend" class="screen hidden">
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-1">
                    <div class="field">
                        <label for="df_nome1">Seu Nome</label>
                        <input id="df_nome1" type="text" placeholder="Ex.: Pedro">
                    </div>
                    <div class="field mt-4">
                        <label>Sua Personalidade</label>
                        <button class="btn-base btn-ghost w-full" id="openPersModal3">
                            <i class="fas fa-sliders-h"></i> Escolher Personalidade
                        </button>
                        <div id="selectedPers3" class="flex flex-wrap gap-1 mt-2 text-xs text-gray-400"></div>
                    </div>
                    <div class="field mt-4">
                        <label for="df_foto1">Sua Foto</label>
                        <label for="df_foto1" class="photo-upload-label">
                            <i class="fas fa-camera"></i> Selecionar Foto
                        </label>
                        <input id="df_foto1" type="file" accept="image/*" class="hidden">
                        <img id="df_foto1_preview" class="photo-preview rounded-xl" alt="Preview da Foto 1">
                    </div>
                </div>
                <div class="flex-1">
                    <div class="field">
                        <label for="df_nome2">Nome do(a) Amigo(a)</label>
                        <input id="df_nome2" type="text" placeholder="Ex.: Joana">
                    </div>
                    <div class="field mt-4">
                        <label>Personalidade do(a) Amigo(a)</label>
                        <button class="btn-base btn-ghost w-full" id="openPersModal4">
                            <i class="fas fa-sliders-h"></i> Escolher Personalidade
                        </button>
                        <div id="selectedPers4" class="flex flex-wrap gap-1 mt-2 text-xs text-gray-400"></div>
                    </div>
                    <div class="field mt-4">
                        <label for="df_foto2">Foto do(a) Amigo(a)</label>
                        <label for="df_foto2" class="photo-upload-label">
                            <i class="fas fa-camera"></i> Selecionar Foto
                        </label>
                        <input id="df_foto2" type="file" accept="image/*" class="hidden">
                        <img id="df_foto2_preview" class="photo-preview rounded-xl" alt="Preview da Foto 2">
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn-base btn-friend-detailed flex-1 btn-animated" id="calcDetailedFriend">
                    <i class="fas fa-calculator"></i> Calcular
                </button>
                <button class="btn-base btn-ghost" id="clearDetailedFriend">
                    <i class="fas fa-eraser"></i> Limpar
                </button>
            </div>
            <div class="card mt-6 text-center space-y-4">
                <div id="badgeDetailedFriend" class="text-sm text-gray-400 font-semibold">‚Äî</div>
                <div id="percentDetailedFriend" class="result-percent text-8xl">0</div>
                <div id="msgDetailedFriend" class="text-sm text-gray-400">Selecione personalidades para um resultado mais detalhado.</div>
                <div class="flex gap-2 mt-4">
                    <button class="btn-base btn-friend-detailed flex-1" id="saveDetailedFriend">
                        <i class="fas fa-download"></i> Salvar
                    </button>
                    <button class="btn-base btn-ghost flex-1" id="shareDetailedFriend">
                        <i class="fas fa-share-alt"></i> Compartilhar
                    </button>
                </div>
            </div>
        </section>

        <!-- Tela Modo Amizade Simples -->
        <section id="screenFriend" class="screen hidden">
            <div class="space-y-4">
                <div class="field">
                    <label for="f_nome1">Seu Nome</label>
                    <input id="f_nome1" type="text" placeholder="Ex.: Pedro" class="rounded-xl">
                </div>
                <div class="field">
                    <label for="f_nome2">Nome do Amigo(a)</label>
                    <input id="f_nome2" type="text" placeholder="Ex.: Joana" class="rounded-xl">
                </div>
                <div class="flex gap-2">
                    <button class="btn-base btn-friend flex-1 btn-animated" id="calcFriend">
                        <i class="fas fa-calculator"></i> Calcular
                    </button>
                    <button class="btn-base btn-ghost" id="swapFriend">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button class="btn-base btn-ghost" id="clearFriend">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
            <div class="card mt-6 text-center space-y-4">
                <div id="badgeFriend" class="text-sm text-gray-400 font-semibold">‚Äî</div>
                <div id="percentFriend" class="result-percent text-8xl">0</div>
                <div id="msgFriend" class="text-sm text-gray-400">Preencha os nomes e toque em Calcular.</div>
                <div class="flex gap-2 mt-4">
                    <button class="btn-base btn-friend flex-1" id="saveFriend">
                        <i class="fas fa-download"></i> Salvar
                    </button>
                    <button class="btn-base btn-ghost flex-1" id="shareFriend">
                        <i class="fas fa-share-alt"></i> Compartilhar
                    </button>
                </div>
            </div>
        </section>

        <!-- Tela de Hist√≥rico -->
        <section id="screenHistory" class="screen hidden">
            <h3 class="text-xl font-bold mb-4">Hist√≥rico de Testes</h3>
            <div id="historyList" class="flex flex-col gap-3"></div>
            <div class="mt-4 text-center">
                <button class="btn-base btn-ghost" id="clearHistory">
                    <i class="fas fa-trash-alt"></i> Limpar Hist√≥rico
                </button>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" data-target="home">
            <i class="fas fa-home"></i>
        </div>
        <div class="nav-item" data-target="history">
            <i class="fas fa-history"></i>
        </div>
    </nav>

    <!-- Modal para mensagens, agora gen√©rico -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-100 mb-2"></h3>
            <p id="modalMessage" class="text-gray-300"></p>
            <div class="flex gap-2 mt-6">
                <button id="modalClose" class="btn-base btn-primary flex-1">OK</button>
                <button id="modalActionBtn" class="btn-base btn-ghost flex-1 hidden">A√ß√£o</button>
            </div>
        </div>
    </div>

    <!-- NOVO MODAL: Escolha de Personalidade -->
    <div id="modalPersonality" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Escolha a Personalidade</h3>
            <div class="modal-content-container">
                <div class="flex flex-wrap gap-2 justify-center" id="persChipsContainer">
                    <!-- Chips de personalidade ser√£o injetados aqui via JS -->
                </div>
            </div>
            <button id="btnConfirmPers" class="mt-6 btn-base btn-primary w-full">
                Confirmar
            </button>
        </div>
    </div>
</div>

<script>
    // --- Screen and Navigation Management ---
    const screens = {
        home: document.getElementById('screenHome'),
        simple: document.getElementById('screenSimple'),
        advanced: document.getElementById('screenAdvanced'),
        friend: document.getElementById('screenFriend'),
        detailedFriend: document.getElementById('screenDetailedFriend'),
        history: document.getElementById('screenHistory')
    };

    const navTabs = document.querySelectorAll('.bottom-nav .nav-item');
    const appTitle = document.getElementById('appTitle');
    const heartParticlesContainer = document.getElementById('heartParticles');
    const root = document.documentElement;

    const titles = {
        home: 'Love Tester',
        simple: 'Conex√£o de Almas',
        advanced: 'Qu√≠mica Perfeita',
        friend: 'Vibe de Amizade',
        detailedFriend: 'Sintonia de Almas',
        history: 'Hist√≥rico'
    };

    const THEMES = {
        love: {
            bg1: '#1a082b', bg2: '#3a005c', accent: '#ff4d8d', accent2: '#8b5cf6'
        },
        friend: {
            bg1: '#082b2b', bg2: '#005c5c', accent: '#5cb6f6', accent2: '#ff8c00'
        }
    };

    /**
     * Define o tema de cores da interface.
     * @param {string} themeName - Nome do tema ('love' ou 'friend').
     */
    function setTheme(themeName) {
        const theme = THEMES[themeName];
        if (!theme) return;
        root.style.setProperty('--bg1', theme.bg1);
        root.style.setProperty('--bg2', theme.bg2);
        root.style.setProperty('--accent', theme.accent);
        root.style.setProperty('--accent2', theme.accent2);
    }

    /**
     * Exibe a tela correspondente ao nome e atualiza a barra de navega√ß√£o e t√≠tulo.
     * @param {string} screenName - O nome da tela a ser exibida.
     */
    function showScreen(screenName) {
        Object.values(screens).forEach(screen => {
            screen.classList.remove('active');
            screen.classList.add('hidden');
        });
        const activeScreen = screens[screenName];
        if (activeScreen) {
            activeScreen.classList.remove('hidden');
            activeScreen.classList.add('active');
        }
        appTitle.textContent = titles[screenName] || 'Love Tester';
        navTabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.target === screenName);
        });

        if (screenName === 'friend' || screenName === 'detailedFriend') {
            setTheme('friend');
        } else {
            setTheme('love');
        }
        if (screenName === 'history') {
            renderHistory();
        }
    }

    // Event listeners para navega√ß√£o
    document.getElementById('openSimple').addEventListener('click', () => showScreen('simple'));
    document.getElementById('openAdvanced').addEventListener('click', () => showScreen('advanced'));
    document.getElementById('openFriend').addEventListener('click', () => showScreen('friend'));
    document.getElementById('openDetailedFriend').addEventListener('click', () => showScreen('detailedFriend'));
    document.getElementById('openHistory').addEventListener('click', () => showScreen('history'));

    document.querySelectorAll('.bottom-nav .nav-item').forEach(button => {
        button.addEventListener('click', (e) => {
            const target = e.currentTarget.dataset.target;
            showScreen(target);
        });
    });

    // --- Custom Modal ---
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalClose = document.getElementById('modalClose');
    const modalActionBtn = document.getElementById('modalActionBtn');

    let confirmAction = null;
    let secondaryAction = null;

    /**
     * Exibe um modal gen√©rico com uma mensagem.
     * @param {string} title - T√≠tulo do modal.
     * @param {string} message - Mensagem do modal.
     * @param {Function} [callback] - Fun√ß√£o a ser executada ao fechar o modal.
     * @param {boolean} [isError=false] - Define se a mensagem √© de erro.
     * @param {string} [actionText] - Texto para o bot√£o de a√ß√£o secund√°rio.
     * @param {Function} [actionCallback] - Fun√ß√£o para o bot√£o de a√ß√£o secund√°rio.
     */
    function showModal(title, message, callback = null, isError = false, actionText = null, actionCallback = null) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalTitle.classList.toggle('error-message', isError);

        modalClose.textContent = 'OK';
        confirmAction = callback;

        if (actionText && actionCallback) {
            modalActionBtn.textContent = actionText;
            secondaryAction = actionCallback;
            modalActionBtn.classList.remove('hidden');
        } else {
            modalActionBtn.classList.add('hidden');
        }

        modal.classList.add('open');
    }

    modalClose.addEventListener('click', () => {
        modal.classList.remove('open');
        if (confirmAction) {
            confirmAction();
            confirmAction = null;
        }
    });

    modalActionBtn.addEventListener('click', () => {
        modal.classList.remove('open');
        if (secondaryAction) {
            secondaryAction();
            secondaryAction = null;
        }
    });

    document.getElementById('btnHelp').addEventListener('click', () => {
        showModal(
            'Sobre o App',
            'Love Tester √© um aplicativo divertido para calcular a compatibilidade entre nomes. Use o modo simples ou avan√ßado, adicione fotos e salve seus resultados!'
        );
    });

    // --- Core Logic ---
    /**
     * Normaliza uma string para compara√ß√£o.
     * @param {string} str - A string a ser normalizada.
     * @returns {string} - A string normalizada.
     */
    function normalize(str) {
        if (typeof str !== 'string') return '';
        return str.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/[^a-z\s]/g, '').trim();
    }

    /**
     * Gera um percentual determin√≠stico a partir de dois nomes e uma semente.
     * @param {string} a - Primeiro nome.
     * @param {string} b - Segundo nome.
     * @param {number} seed - Semente para o c√°lculo (ex: 0 para amor, 1 para amizade).
     * @returns {number|null} - Percentual de compatibilidade ou null se os nomes estiverem vazios.
     */
    function deterministicPercent(a, b, seed = 0) {
        const n1 = normalize(a), n2 = normalize(b);
        if (!n1 || !n2) return null;
        const pair = [n1, n2].sort().join('‚ô•') + '::' + String(seed);
        let h = 2166136261 >>> 0;
        for (let i = 0; i < pair.length; i++) {
            h ^= pair.charCodeAt(i);
            h = Math.imul(h, 16777619);
        }
        h ^= h >>> 13;
        h = Math.imul(h, 0x5bd1e995);
        h ^= h >>> 15;
        return Math.abs(h) % 101;
    }

    const persMap = {
        'Aventureiro(a)': 6, 'Calmo(a)': 4, 'Rom√¢ntico(a)': 8, 'Intelectual': 5,
        'Criativo(a)': 7, 'Leal': 9, 'Bem-humorado(a)': 6, 'Espont√¢neo(a)': 5,
        'Observador(a)': 3, 'Otimista': 4, 'Realista': 2, 'Ambicioso(a)': 5,
        'Extrovertido(a)': 7, 'Introvertido(a)': 2, 'Pessoa da Fam√≠lia': 8,
        'Alegre': 5, 'Sereno(a)': 4, 'Protetor(a)': 8, 'Curioso(a)': 6,
        'Emp√°tico(a)': 9, 'Resiliente': 7, 'Sincero(a)': 8, 'Gentil': 7,
        'Espiritual': 6, 'Organizado(a)': 4, 'Desapegado(a)': 3, 'Comunicativo(a)': 5,
        'L√≠der': 6
    };
    const persOptions = Object.keys(persMap);

    let currentPersField = null;
    let selectedPers = {
        love1: [], love2: [], friend1: [], friend2: []
    };
    let photoUrls = {
        love1: null, love2: null, friend1: null, friend2: null
    };

    /**
     * Calcula a semente da personalidade.
     * @param {Array<string>} chips - Array de tra√ßos de personalidade selecionados.
     * @returns {number} - A semente calculada.
     */
    function personalitySeed(chips) {
        let seed = 0;
        chips.forEach(c => seed += (persMap[c] || 0));
        return seed;
    }

    // Frases para o resultado
    const lovePhrases = [{
        min: 95,
        text: ['Uma conex√£o m√°gica! A compatibilidade de voc√™s √© de %%%. ‚ù§Ô∏è Sintonizados em uma frequ√™ncia √∫nica, voc√™s s√£o raros.', 'Alma g√™mea detectada! A sintonia √© de %%%. üíû O destino parece ter um plano incr√≠vel para voc√™s.', 'O amor de voc√™s √© po√©tico, uma melodia perfeita. Com %%% de sintonia, "Nossos cora√ß√µes dan√ßam ao mesmo ritmo".']
    }, {
        min: 80,
        text: ['Qu√≠mica poderosa! Essa conex√£o de %%% pode se tornar uma grande paix√£o. üî•', 'Um encontro de almas vibrantes! Com %%%, o futuro de voc√™s promete uma jornada fascinante juntos.', 'Potencial para um romance inesquec√≠vel! A compatibilidade de %%% √© alta. Sigam o cora√ß√£o, ele n√£o mente. üí´']
    }, {
        min: 65,
        text: ['Compatibilidade forte! A conex√£o de %%% √© uma base s√≥lida para construir algo bonito. üèóÔ∏è', 'Uma bela combina√ß√£o! A atra√ß√£o de %%% entre voc√™s √© vis√≠vel. Vale a pena investir nesse sentimento. üòä', 'H√° uma forte afinidade. A compatibilidade de voc√™s √© de %%%. Cultivem esse amor com paci√™ncia e dedica√ß√£o. ü™¥']
    }, {
        min: 50,
        text: ['Uma mistura interessante! Com %%% de compatibilidade, com di√°logo e abertura, pode florescer um grande amor. üó£Ô∏è', 'Talvez seja um caso de "opostos se atraem". Com %%% de qu√≠mica, o desafio pode ser a parte mais divertida da jornada. üé≤', 'Uma compatibilidade moderada. Com %%%, o destino est√° na sua m√£o ‚Äî o que voc√™s v√£o fazer com ela? ü§î']
    }, {
        min: 0,
        text: ['A vida √© uma caixinha de surpresas! A afinidade de voc√™s √© de %%%. Talvez a conex√£o esteja em algo que a gente nem imagina. üòÆ', 'Toda hist√≥ria de amor come√ßa em algum lugar, e a de voc√™s pode estar apenas come√ßando. A compatibilidade √© de %%%. üé¨', 'A amizade √© a base de todo relacionamento. Com %%% de sintonia, quem sabe essa amizade se torne algo mais? ‚ú®']
    }];

    const friendPhrases = [{
        min: 95,
        text: ['Voc√™s s√£o insepar√°veis! A amizade de voc√™s √© de %%%. ü§ù Uma conex√£o rara e de pura sintonia.', 'Melhores amigos para a vida! A afinidade √© de %%%. A parceria de voc√™s √© uma b√™n√ß√£o. ‚ú®', 'Uma amizade de milh√µes! Com %%%, "Juntos, transformamos o trivial em grandes aventuras".']
    }, {
        min: 80,
        text: ['Uma amizade forte e sincera! A vibe de voc√™s √© de %%%. H√° um respeito e um carinho poderosos.', 'Companheiros de aventuras! A sintonia de voc√™s √© de %%%. Compartilham risadas e momentos inesquec√≠veis. üòÑ', 'Uma amizade com muito futuro! Com %%% de afinidade, os melhores momentos ainda est√£o por vir. üéâ']
    }, {
        min: 65,
        text: ['Uma amizade promissora! A compatibilidade de %%% √© uma √≥tima base para construir uma rela√ß√£o s√≥lida. —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç', 'A afinidade √© boa! Com %%%, voc√™s se entendem bem e t√™m muito o que compartilhar. üí¨', 'Uma conex√£o em crescimento. Com %%%, as diferen√ßas podem se tornar grandes li√ß√µes. üåü']
    }, {
        min: 50,
        text: ['Amizade em desenvolvimento! Com %%%, a vida pode ser mais divertida se passarem mais tempo juntos. ü•≥', 'Vibra√ß√µes mistas! A compatibilidade de %%% mostra que h√° espa√ßo para se conhecerem melhor e encontrar interesses em comum. üîé', 'Uma vibe neutra. Com %%%, o destino est√° na sua m√£o, e a amizade pode florescer com o tempo. ‚è≥']
    }, {
        min: 0,
        text: ['Talvez a amizade de voc√™s ainda esteja no come√ßo. A compatibilidade √© de %%%. O que importa √© ter abertura para aprender um com o outro. ü§ì', 'O que importa √© a jornada e n√£o o destino. A afinidade de voc√™s √© de %%%. Aproveitem o momento e as descobertas. üó∫Ô∏è', 'Amigos de diferentes mundos! Com %%% de compatibilidade, voc√™s podem aprender muito um com o outro. üëΩ']
    }];

    /**
     * Seleciona uma frase de resultado com base no percentual e no modo.
     * @param {number} pct - O percentual de compatibilidade.
     * @param {string} mode - O modo do teste ('simple', 'advanced', 'friend', 'detailedFriend').
     * @returns {string} - A frase correspondente.
     */
    function pickPhrase(pct, mode) {
        const phrases = (mode.includes('friend') || mode === 'detailedFriend') ? friendPhrases : lovePhrases;
        for (const bucket of phrases) {
            if (pct >= bucket.min) {
                const text = bucket.text[Math.floor(Math.random() * bucket.text.length)];
                return text.replace('%%%', pct);
            }
        }
        return 'Resultado inesperado ‚Äî tente novamente!';
    }

    // --- Canvas for Image Generation ---
    function renderCardToCanvas(title, badge, pct, msg, photo1 = null, photo2 = null, callback) {
        const w = 900, h = 1200;
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        const ctx = c.getContext('2d');

        // Fun√ß√µes auxiliares movidas para dentro para garantir o escopo
        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
        }

        function drawImageProp(ctx, img, x, y, w, h) {
            const imgRatio = img.width / img.height;
            const canvasRatio = w / h;
            let sx, sy, sW, sH;
            if (imgRatio > canvasRatio) { // Image is wider than container
                sH = img.height;
                sW = img.height * canvasRatio;
                sx = (img.width - sW) / 2;
                sy = 0;
            } else { // Image is taller or same aspect ratio
                sW = img.width;
                sH = img.width / canvasRatio;
                sx = 0;
                sy = (img.height - sH) / 2;
            }
            ctx.drawImage(img, sx, sy, sW, sH, x, y, w, h);
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            ctx.textAlign = 'center';
            const words = text.split(' ');
            let line = '';
            let test = '';
            let curY = y;
            for (let n = 0; n < words.length; n++) {
                test = line + words[n] + ' ';
                const metrics = ctx.measureText(test);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line.trim(), x, curY);
                    line = words[n] + ' ';
                    curY += lineHeight;
                } else {
                    line = test;
                }
            }
            ctx.fillText(line.trim(), x, curY);
        }

        let bg1 = getComputedStyle(document.documentElement).getPropertyValue('--bg1');
        let bg2 = getComputedStyle(document.documentElement).getPropertyValue('--bg2');
        let accent = getComputedStyle(document.documentElement).getPropertyValue('--accent');
        let accent2 = getComputedStyle(document.documentElement).getPropertyValue('--accent2');

        // Background
        const g = ctx.createLinearGradient(0, 0, 0, h);
        g.addColorStop(0, bg1);
        g.addColorStop(1, bg2);
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, w, h);

        // Card inner background
        ctx.fillStyle = 'rgba(255,255,255,0.06)';
        roundRect(ctx, 60, 90, w - 120, 220, 28);
        ctx.fill();

        // Photos
        const photoSize = 180;
        const photoMargin = 30;
        const photoY = 130;
        let loadedCount = 0;
        const totalPhotos = (photo1 ? 1 : 0) + (photo2 ? 1 : 0);

        function checkLoad() {
            loadedCount++;
            if (loadedCount === totalPhotos) {
                drawTextContent();
            }
        }

        if (photo1) {
            const p1 = new Image();
            p1.crossOrigin = 'anonymous';
            p1.onload = () => {
                ctx.save();
                ctx.beginPath();
                ctx.arc(w / 2 - photoSize / 2 - photoMargin / 2, photoY + photoSize / 2, photoSize / 2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                drawImageProp(ctx, p1, w / 2 - photoSize - photoMargin, photoY, photoSize, photoSize);
                ctx.restore();
                checkLoad();
            };
            p1.src = photo1;
        }

        if (photo2) {
            const p2 = new Image();
            p2.crossOrigin = 'anonymous';
            p2.onload = () => {
                ctx.save();
                ctx.beginPath();
                ctx.arc(w / 2 + photoSize / 2 + photoMargin / 2, photoY + photoSize / 2, photoSize / 2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                drawImageProp(ctx, p2, w / 2 + photoMargin, photoY, photoSize, photoSize);
                ctx.restore();
                checkLoad();
            };
            p2.src = photo2;
        }

        if (totalPhotos === 0) {
            drawTextContent();
        }

        function drawTextContent() {
            ctx.font = '36px Poppins, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillStyle = 'white';
            ctx.fillText(badge, w / 2, 380);

            ctx.font = '28px Poppins';
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            ctx.fillText(title, w / 2, 430);
            ctx.font = '160px Poppins';
            const percentGradient = ctx.createLinearGradient(0, 0, 0, h);
            percentGradient.addColorStop(0, accent);
            percentGradient.addColorStop(1, accent2);
            ctx.fillStyle = percentGradient;
            ctx.fillText(pct + '%', w / 2, 700);

            ctx.font = '28px Poppins';
            wrapText(ctx, msg, w / 2, 850, w - 200, 36);
            ctx.font = '18px Poppins';
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.fillText('Love Tester ‚Ä¢ App', w / 2, h - 80);
            c.toBlob(blob => callback(blob));
        }
    }

    /**
     * Salva um Blob como arquivo no dispositivo do usu√°rio.
     * @param {Blob} blob - O Blob a ser salvo.
     * @param {string} filename - O nome do arquivo.
     */
    function saveBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    // --- History Logic (localStorage) ---
    const HISTORY_KEY = 'loveTesterHistory';

    function getHistory() {
        try {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            return Array.isArray(history) ? history : [];
        } catch (e) {
            console.error("Erro ao ler o hist√≥rico do localStorage:", e);
            return [];
        }
    }

    function saveHistory(history) {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function saveToHistory(obj) {
        const history = getHistory();
        history.unshift({
            ...obj,
            id: Date.now(),
            when: new Date().toISOString()
        });
        saveHistory(history);
    }

    function renderHistory() {
        const historyList = document.getElementById('historyList');
        const history = getHistory();
        historyList.innerHTML = '';

        if (history.length === 0) {
            historyList.innerHTML = `<p class="text-sm text-center text-gray-500">Sem hist√≥rico ‚Äî salve um resultado para aparecer aqui.</p>`;
            return;
        }

        history.forEach((item) => {
            const el = document.createElement('div');
            el.className = 'flex items-center justify-between p-3 rounded-xl border border-gray-700 bg-gray-800 bg-opacity-30';
            const when = new Date(item.when).toLocaleString();
            el.innerHTML = `
                <div class="flex-1 min-w-0">
                    <div class="font-bold text-lg text-white truncate">${item.a} + ${item.b} <span class="font-semibold text-pink-300 ml-2">${item.pct}%</span></div>
                    <div class="text-xs text-gray-400 mt-1">${item.mode} ‚Äî ${when}</div>
                </div>
                <div class="flex gap-2">
                    <button class="btn-base btn-ghost" data-id="${item.id}" data-action="download">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-base btn-ghost text-red-400" data-id="${item.id}" data-action="delete">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            historyList.appendChild(el);
        });
    }

    document.getElementById('historyList').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const itemId = parseInt(target.dataset.id);
        const action = target.dataset.action;
        const currentHistory = getHistory();

        if (action === 'download') {
            const item = currentHistory.find(i => i.id === itemId);
            if (item) {
                renderCardToCanvas(
                    titles[item.mode],
                    `${item.a} + ${item.b}`,
                    item.pct,
                    item.msg,
                    item.photo1,
                    item.photo2,
                    blob => saveBlob(blob, `history-${item.a}-${item.b}.png`)
                );
            }
        } else if (action === 'delete') {
            showModal('Confirmar', 'Tem certeza que deseja apagar este item?', () => {
                const newHistory = currentHistory.filter(i => i.id !== itemId);
                saveHistory(newHistory);
                renderHistory();
            });
        }
    });

    document.getElementById('clearHistory').addEventListener('click', () => {
        showModal('Confirmar', 'Tem certeza que deseja limpar todo o hist√≥rico?', () => {
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
        });
    });

    // --- Animations ---
    function animatePercentage(elementId, finalValue) {
        const element = document.getElementById(elementId);
        let startValue = 0;
        const duration = 1000;
        const startTime = performance.now();

        function update() {
            const elapsed = performance.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const currentValue = Math.floor(progress * finalValue);
            element.textContent = currentValue;
            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                element.textContent = finalValue;
            }
        }
        requestAnimationFrame(update);
    }

    function createHeartParticles() {
        const emojis = ['üíñ', '‚ú®', 'üíû', '‚ù§Ô∏è', 'üåü', 'ü•∞', 'üòç', 'üòò', 'ü§©'];
        for (let i = 0; i < 25; i++) {
            const particle = document.createElement('div');
            particle.className = 'heart-particle';
            particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.animationDelay = `${Math.random() * 2}s`;
            particle.style.animationDuration = `${3 + Math.random() * 2}s`;
            heartParticlesContainer.appendChild(particle);
            particle.addEventListener('animationend', () => {
                particle.remove();
            });
        }
    }

    // --- General Logic for Calculations and Actions ---
    function handleCalculation(mode, name1Id, name2Id, persField1, persField2, percentId, badgeId, msgId, photo1Var, photo2Var) {
        const a = document.getElementById(name1Id).value.trim();
        const b = document.getElementById(name2Id).value.trim();
        if (!a || !b) {
            showModal('Campos Vazios', 'Por favor, preencha os dois nomes para calcular.', null, true);
            return;
        }
        let pct = 0;
        let seed = 0;
        let bonus = 0;

        if (mode === 'simple' || mode === 'friend') {
            seed = (mode === 'friend') ? 1 : 0;
            pct = deterministicPercent(a, b, seed);
        } else {
            seed = personalitySeed(selectedPers[persField1]) + personalitySeed(selectedPers[persField2]);
            const pctBase = deterministicPercent(a, b, seed);
            if (selectedPers[persField1].length && selectedPers[persField2].length) {
                selectedPers[persField1].forEach(x => {
                    if (selectedPers[persField2].includes(x)) bonus += 5;
                });
                if (selectedPers[persField1].includes('Aventureiro(a)') && selectedPers[persField2].includes('Calmo(a)')) bonus += 3;
                if (selectedPers[persField1].includes('Intelectual') && selectedPers[persField2].includes('Intelectual')) bonus += 4;
            }
            pct = Math.min(100, Math.max(0, pctBase + bonus));
        }

        const msg = pickPhrase(pct, mode);

        animatePercentage(percentId, pct);
        document.getElementById(badgeId).textContent = `${a} + ${b}`;
        document.getElementById(msgId).textContent = msg;

        const historyObj = { mode, a, b, pct, msg };
        if (photo1Var) historyObj.photo1 = photoUrls[photo1Var];
        if (photo2Var) historyObj.photo2 = photoUrls[photo2Var];
        saveToHistory(historyObj);
        createHeartParticles();
    }

    function handleSaveOrShare(action, mode, name1Id, name2Id, percentId, msgId, photo1Var, photo2Var) {
        const a = document.getElementById(name1Id).value.trim();
        const b = document.getElementById(name2Id).value.trim();
        if (!a || !b) {
            showModal('Sem Resultado', 'Calcule um resultado antes de ' + (action === 'save' ? 'salvar' : 'compartilhar') + '.', null, true);
            return;
        }
        const pct = document.getElementById(percentId).textContent;
        const msg = document.getElementById(msgId).textContent;
        const photo1 = photo1Var ? photoUrls[photo1Var] : null;
        const photo2 = photo2Var ? photoUrls[photo2Var] : null;

        renderCardToCanvas(titles[mode], `${a} + ${b}`, pct, msg, photo1, photo2, async (blob) => {
            if (action === 'save') {
                saveBlob(blob, `${mode}-${a}-${b}.png`);
            } else if (action === 'share') {
                const filesArray = [new File([blob], `${mode}-${a}-${b}.png`, { type: blob.type })];
                if (navigator.canShare && navigator.canShare({ files: filesArray })) {
                    try {
                        await navigator.share({ files: filesArray, title: titles[mode], text: `${a} + ${b}` });
                        return;
                    } catch (e) {
                        console.warn(e);
                    }
                }
                // Fallback para download caso o compartilhamento falhe
                saveBlob(blob, `${mode}-${a}-${b}.png`);
                showModal('Compartilhamento', 'A imagem foi baixada. Compartilhe manualmente!');
            }
        });
    }

    function handleClear(name1Id, name2Id, percentId, msgId, badgeId, persField1, persField2, photo1Id, photo2Id) {
        document.getElementById(name1Id).value = '';
        document.getElementById(name2Id).value = '';
        document.getElementById(percentId).textContent = '0';
        document.getElementById(msgId).textContent = (persField1) ? 'Selecione personalidades para um resultado mais detalhado.' : 'Preencha os nomes e toque em Calcular.';
        document.getElementById(badgeId).textContent = '‚Äî';
        if (persField1) {
            selectedPers[persField1] = [];
            selectedPers[persField2] = [];
            document.getElementById(`selectedPers1`).textContent = '';
            document.getElementById(`selectedPers2`).textContent = '';
        }
        if (photo1Id) {
            photoUrls[photo1Id] = null;
            photoUrls[photo2Id] = null;
            document.getElementById(`${photo1Id}_preview`).src = '';
            document.getElementById(`${photo1Id}_preview`).classList.remove('active');
            document.getElementById(`${photo2Id}_preview`).src = '';
            document.getElementById(`${photo2Id}_preview`).classList.remove('active');
        }
    }

    // --- Simple Mode Event Listeners ---
    document.getElementById('calcSimple').addEventListener('click', () => handleCalculation('simple', 's_nome1', 's_nome2', null, null, 'percentSimple', 'badgeSimple', 'msgSimple'));
    document.getElementById('saveSimple').addEventListener('click', () => handleSaveOrShare('save', 'simple', 's_nome1', 's_nome2', 'percentSimple', 'msgSimple'));
    document.getElementById('shareSimple').addEventListener('click', () => handleSaveOrShare('share', 'simple', 's_nome1', 's_nome2', 'percentSimple', 'msgSimple'));
    document.getElementById('swapSimple').addEventListener('click', () => {
        const t = document.getElementById('s_nome1').value;
        document.getElementById('s_nome1').value = document.getElementById('s_nome2').value;
        document.getElementById('s_nome2').value = t;
    });
    document.getElementById('clearSimple').addEventListener('click', () => handleClear('s_nome1', 's_nome2', 'percentSimple', 'msgSimple', 'badgeSimple'));

    // --- Advanced Mode Event Listeners ---
    document.getElementById('calcAdvanced').addEventListener('click', () => handleCalculation('advanced', 'a_nome1', 'a_nome2', 'love1', 'love2', 'percentAdvanced', 'badgeAdvanced', 'msgAdvanced', 'photo1', 'photo2'));
    document.getElementById('saveAdvanced').addEventListener('click', () => handleSaveOrShare('save', 'advanced', 'a_nome1', 'a_nome2', 'percentAdvanced', 'msgAdvanced', 'love1', 'love2'));
    document.getElementById('shareAdvanced').addEventListener('click', () => handleSaveOrShare('share', 'advanced', 'a_nome1', 'a_nome2', 'percentAdvanced', 'msgAdvanced', 'love1', 'love2'));
    document.getElementById('clearAdvanced').addEventListener('click', () => handleClear('a_nome1', 'a_nome2', 'percentAdvanced', 'msgAdvanced', 'badgeAdvanced', 'love1', 'love2', 'a_foto1', 'a_foto2'));

    // --- Detailed Friend Mode Event Listeners ---
    document.getElementById('calcDetailedFriend').addEventListener('click', () => handleCalculation('detailedFriend', 'df_nome1', 'df_nome2', 'friend1', 'friend2', 'percentDetailedFriend', 'badgeDetailedFriend', 'msgDetailedFriend', 'photo3', 'photo4'));
    document.getElementById('saveDetailedFriend').addEventListener('click', () => handleSaveOrShare('save', 'detailedFriend', 'df_nome1', 'df_nome2', 'percentDetailedFriend', 'msgDetailedFriend', 'friend1', 'friend2'));
    document.getElementById('shareDetailedFriend').addEventListener('click', () => handleSaveOrShare('share', 'detailedFriend', 'df_nome1', 'df_nome2', 'percentDetailedFriend', 'msgDetailedFriend', 'friend1', 'friend2'));
    document.getElementById('clearDetailedFriend').addEventListener('click', () => handleClear('df_nome1', 'df_nome2', 'percentDetailedFriend', 'msgDetailedFriend', 'badgeDetailedFriend', 'friend1', 'friend2', 'df_foto1', 'df_foto2'));

    // --- Simple Friend Mode Event Listeners ---
    document.getElementById('calcFriend').addEventListener('click', () => handleCalculation('friend', 'f_nome1', 'f_nome2', null, null, 'percentFriend', 'badgeFriend', 'msgFriend'));
    document.getElementById('saveFriend').addEventListener('click', () => handleSaveOrShare('save', 'friend', 'f_nome1', 'f_nome2', 'percentFriend', 'msgFriend'));
    document.getElementById('shareFriend').addEventListener('click', () => handleSaveOrShare('share', 'friend', 'f_nome1', 'f_nome2', 'percentFriend', 'msgFriend'));
    document.getElementById('swapFriend').addEventListener('click', () => {
        const t = document.getElementById('f_nome1').value;
        document.getElementById('f_nome1').value = document.getElementById('f_nome2').value;
        document.getElementById('f_nome2').value = t;
    });
    document.getElementById('clearFriend').addEventListener('click', () => handleClear('f_nome1', 'f_nome2', 'percentFriend', 'msgFriend', 'badgeFriend'));

    // --- Personality Modal Logic ---
    function renderPersonalityChips(containerId, activeTraits) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        persOptions.forEach(trait => {
            const chip = document.createElement('button');
            chip.textContent = trait;
            chip.classList.add('chip');
            chip.dataset.val = trait;
            if (activeTraits.includes(trait)) {
                chip.classList.add('active');
            }
            container.appendChild(chip);
        });
    }

    document.getElementById('openPersModal1').addEventListener('click', () => {
        currentPersField = 'love1';
        renderPersonalityChips('persChipsContainer', selectedPers.love1);
        document.getElementById('modalPersonality').classList.add('open');
    });

    document.getElementById('openPersModal2').addEventListener('click', () => {
        currentPersField = 'love2';
        renderPersonalityChips('persChipsContainer', selectedPers.love2);
        document.getElementById('modalPersonality').classList.add('open');
    });

    document.getElementById('openPersModal3').addEventListener('click', () => {
        currentPersField = 'friend1';
        renderPersonalityChips('persChipsContainer', selectedPers.friend1);
        document.getElementById('modalPersonality').classList.add('open');
    });

    document.getElementById('openPersModal4').addEventListener('click', () => {
        currentPersField = 'friend2';
        renderPersonalityChips('persChipsContainer', selectedPers.friend2);
        document.getElementById('modalPersonality').classList.add('open');
    });

    document.getElementById('persChipsContainer').addEventListener('click', (e) => {
        if (e.target.classList.contains('chip')) {
            e.target.classList.toggle('active');
        }
    });

    document.getElementById('btnConfirmPers').addEventListener('click', () => {
        const activeChips = Array.from(document.querySelectorAll('#persChipsContainer .chip.active')).map(c => c.dataset.val);
        if (currentPersField === 'love1') {
            selectedPers.love1 = activeChips;
            document.getElementById('selectedPers1').textContent = activeChips.join(', ') || 'Nenhuma';
        } else if (currentPersField === 'love2') {
            selectedPers.love2 = activeChips;
            document.getElementById('selectedPers2').textContent = activeChips.join(', ') || 'Nenhuma';
        } else if (currentPersField === 'friend1') {
            selectedPers.friend1 = activeChips;
            document.getElementById('selectedPers3').textContent = activeChips.join(', ') || 'Nenhuma';
        } else if (currentPersField === 'friend2') {
            selectedPers.friend2 = activeChips;
            document.getElementById('selectedPers4').textContent = activeChips.join(', ') || 'Nenhuma';
        }
        document.getElementById('modalPersonality').classList.remove('open');
    });

    // Photo upload logic
    function setupPhotoUpload(inputId, previewId, urlVarName) {
        document.getElementById(inputId).addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoUrls[urlVarName] = e.target.result;
                    document.getElementById(previewId).src = e.target.result;
                    document.getElementById(previewId).classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        });
    }

    setupPhotoUpload('a_foto1', 'a_foto1_preview', 'love1');
    setupPhotoUpload('a_foto2', 'a_foto2_preview', 'love2');
    setupPhotoUpload('df_foto1', 'df_foto1_preview', 'friend1');
    setupPhotoUpload('df_foto2', 'df_foto2_preview', 'friend2');

    // Inicia o app na tela inicial
    window.onload = () => {
        showScreen('home');
    };
</script>

</body>
</html>
